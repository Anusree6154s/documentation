<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Content Manager</title>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>
  <body>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>

    <script>
      async function initializeCMS() {
        try {
          console.log("üöÄ Initializing CMS...");
          await CMS.init();
          console.log("‚úÖ CMS initialized successfully.");
        } catch (err) {
          console.error("‚ùå CMS.init error:", err);
          document.body.innerHTML = `<p>CMS failed to load. Check console for errors.</p>`;
        }
      }

      // Initial CMS load (shows login button)
      initializeCMS();

      window.addEventListener("message", async (e) => {
        const { code, state } = e.data || {};
        console.log("üì© Message received from popup:", e.data);

        if (code) {
          console.log("üöÄ ~ window.addEventListener ~ code:", code);

          try {
            const response = await fetch(
              `https://netlify-cms-github-oauth-bf5t.onrender.com/auth/callback?code=${code}&state=${state}`
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.token) {
              console.log("üöÄ ~ window.addEventListener ~ data.token:", data.token);

              await CMS.auth.login(data.token);

              // Clear the page content just to be safe
              document.body.innerHTML = "";

              // Re-initialize CMS for authenticated session
              await initializeCMS();
            } else {
              console.error("OAuth callback failed", data);
              document.body.innerHTML =
                "<p>Authentication failed: No token returned.</p>";
            }
          } catch (err) {
            console.error("‚ùå Error during OAuth token exchange or CMS login:", err);
            document.body.innerHTML = `<p>Authentication error: ${err.message}</p>`;
          }
        }
      });
    </script>
  </body>
</html>
